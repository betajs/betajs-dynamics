/*!
betajs-dynamics - v0.0.1 - 2015-01-17
Copyright (c) Oliver Friedmann,Victor Lingenthal
MIT Software License.
*/
BetaJS.Dynamics=BetaJS.Dynamics||{},BetaJS.Dynamics.Parser={parseText:function(a){if(!a)return null;for(var b=[];a;){var c=a.indexOf("{{"),d=null;if(0===c){for(c=a.indexOf("}}");c+2<a.length&&"}"==a.charAt(c+2);)c++;c>=0?(c+=2,d=this.parseCode(a.substring(2,c-2))):c=a.length}else 0>c&&(c=a.length);b.push(d?d:a.substring(0,c)),a=a.substring(c)}if(1==b.length)return BetaJS.Types.is_string(b[0])?null:b[0];var e={};return BetaJS.Objs.iter(b,function(a){BetaJS.Types.is_string(a)||BetaJS.Objs.iter(a.dependencies,function(a){e[a]=!0})}),{func:function(a){var c=null;return BetaJS.Objs.iter(b,function(b){var d=BetaJS.Types.is_string(b)?b:b.func(a);c=null===c?d:c+d}),c},dependencies:BetaJS.Objs.keys(e)}},executeCode:function(a,b){if(BetaJS.Types.is_string(a))return a;var c={};BetaJS.Objs.iter(a.dependencies,function(a){a=a.indexOf(".")>=0?a.substring(0,a.indexOf(".")):a;for(var d=b.length-1;d>=0;--d)if(a in b[d]){c[a]=b[d][a],c[a]&&BetaJS.Properties.Properties.is_instance_of(c[a])&&(c[a]=c[a].data());break}a in c||a in window||(c[a]=null)});var d=a.func(c);return d},parseCode:function(a){var b=!1;"="==a.charAt(0)&&(b=!0,a=a.substring(1));var c=a.indexOf("::"),d=null;return c>=0&&(d=a.substring(0,c).trim(),a=a.substring(c+2)),{bidirectional:b,args:d,variable:b?a:null,func:new Function("obj","with (obj) { return "+a+"; }"),dependencies:BetaJS.JavaScript.extractIdentifiers(a,!0)}}},BetaJS.Class.extend("BetaJS.Scopes.Scope",[BetaJS.Events.EventsMixin,BetaJS.Events.ListenMixin,BetaJS.Classes.ObjectIdMixin,{constructor:function(a){a=BetaJS.Objs.extend({functions:{},data:{},parent:null,scopes:{},bind:{},attrs:{},collections:{}},a);var b=a.parent;this.__manager=b?b.__manager:this._auto_destroy(new BetaJS.Scopes.ScopeManager(this)),this._inherited(BetaJS.Scopes.Scope,"constructor"),this.__parent=b,this.__root=b?b.root():this,this.__children={},this.__properties=new BetaJS.Properties.Properties,this.__properties.on("change",function(a,b,c){this.trigger("change:"+a,b,c)},this),this.__functions=a.functions,this.__scopes={},this.__data=a.data,this.setAll(a.attrs),BetaJS.Objs.iter(a.collections,function(a,b){this.set(b,new BetaJS.Collections.Collection(a))},this),b&&b.__add(this),this.scopes=BetaJS.Objs.map(a.scopes,function(a){return this.scope(a)},this),BetaJS.Objs.iter(a.bind,function(a,b){var c=a.indexOf(":");this.bind(this.scope(a.substring(0,c)),b,{secondKey:a.substring(c+1)})},this)},destroy:function(){BetaJS.Objs.iter(this.__scopes,function(a){a.destroy()}),BetaJS.Objs.iter(this.__children,function(a){a.destroy()}),this.__properties.destroy(),this.__parent&&this.__parent.__remove(this),this.trigger("destroy"),this._inherited(BetaJS.Scopes.Scope,"destroy")},__object_id_scope:function(){return this.__manager},__add:function(a){this.__children[a.cid()]=a,this.trigger("add",a)},__remove:function(a){this.trigger("remove",a),delete this.__children[a.cid()]},data:function(a,b){return 0===arguments.length?this.__data:1===arguments.length?this.__data[a]:(this.__data[a]=b,this.trigger("data",a,b),this)},set:function(a,b){return this.__properties.set(a,b),this},setAll:function(a){return this.__properties.setAll(a),this},get:function(a){return this.__properties.get(a)},define:function(a,b,c){return this.__functions[a]=BetaJS.Functions.as_method(b,c||this),this},call:function(a){return this.__functions[a].apply(this,BetaJS.Functions.getArguments(arguments,1))},parent:function(){return this.__parent},root:function(){return this.__root},children:function(){return this.scope(">")},properties:function(){return this.__properties},scope:function(a,b){if(arguments.length<2&&(b=a,a=this),!b)return a;if(a&&a.instance_of(BetaJS.Scopes.MultiScope)&&(a=a.iterator().next()),!a)return a;var c=BetaJS.Ids.objectId(a)+"_"+b;return this.__scopes[c]||(this.__scopes[c]=new BetaJS.Scopes.MultiScope(this,a,b)),this.__scopes[c]},bind:function(a,b,c){if(a.instance_of(BetaJS.Scopes.MultiScope)){for(var d=a.iterator();d.hasNext();)this.properties().bind(b,d.next().properties(),c);a.on("addscope",function(a){this.properties().bind(b,a.properties(),c)},this),a.on("removescope",function(a){this.properties().unbind(b,a.properties())},this)}else this.properties().bind(b,a.properties(),c)}}]),BetaJS.Class.extend("BetaJS.Scopes.MultiScope",[BetaJS.Events.EventsMixin,BetaJS.Events.ListenMixin,{constructor:function(a,b,c){this._inherited(BetaJS.Scopes.MultiScope,"constructor"),this.__owner=a,this.__base=b,this.__queryStr=c,this.__query=this.__owner.__manager.query(this.__owner,c),this.__query.on("add",function(a){this.delegateEvents(null,a),this.trigger("addscope",a)},this),this.__query.on("remove",function(a){a.off(null,null,this),this.trigger("removescope",a)},this),BetaJS.Objs.iter(this.__query.result(),function(a){this.delegateEvents(null,a)},this),this.__freeze=!1},destroy:function(){BetaJS.Objs.iterate(this.__query.result(),function(a){a.off(null,null,this)},this),this.__query.destroy(),this._inherited(BetaJS.Scopes.MultiScope,"destroy")},iterator:function(){return new BetaJS.Iterators.ArrayIterator(this.__query.result())},set:function(a,b){for(var c=this.iterator();c.hasNext();)c.next().set(a,b);return this},get:function(a){var b=this.iterator();return b.hasNext()?b.next().get(a,value):null},define:function(a,b){for(var c=this.iterator();c.hasNext();)c.next().define(a,b);return this},call:function(){for(var a=this.iterator(),b=null;a.hasNext();){var c=a.next(),d=c.call.apply(c,arguments);b=b||d}return b},parent:function(){return this.__owner.scope(this.__base,this.__queryStr+"<")},root:function(){return this.__owner.root()},children:function(){return this.__owner.scope(this.__base,this.__queryStr+">")},scope:function(a,b){return arguments.length<2?this.__owner.scope(this.__base,this.__queryStr+b):this.__owner.scope(a,b)},materialize:function(a){return a?this.iterator().next():this.iterator().asArray()},freeze:function(){this.__freeze=!0,this.__query.off("add",null,this)}}]),BetaJS.Class.extend("BetaJS.Scopes.ScopeManager",[BetaJS.Trees.TreeNavigator,BetaJS.Classes.ObjectIdScopeMixin,{constructor:function(a){this._inherited(BetaJS.Scopes.ScopeManager,"constructor"),this.__root=a,this.__watchers=[],this.__query=this._auto_destroy(new BetaJS.Trees.TreeQueryEngine(this))},nodeRoot:function(){return this.__root},nodeId:function(a){return a.cid()},nodeParent:function(a){return a.__parent},nodeChildren:function(a){return a.__children},nodeData:function(a){return a.data()},nodeWatch:function(a,b,c){a.on("data",function(){b.call(c,"data")},c),a.on("add",function(a){b.call(c,"addChild",a)},c),a.on("destroy",function(){b.call(c,"remove")},c)},nodeUnwatch:function(a,b,c){a.off(null,null,c)},query:function(a,b){return this.__query.query(a,b)}}]),BetaJS.Dynamics.HandlerMixin={_notifications:{_construct:"__handlerConstruct",_destruct:"__handlerDestruct"},__handlerConstruct:function(){},__handlerDestruct:function(){this.__rootNode&&this.__rootNode.destroy()},_handlerInitialize:function(a){a=a||{},this._parentHandler=a.parentHandler||null;var b=a.template||this.template;if(this.__element=a.element?a.element:null,b)this._handlerInitializeTemplate(b,a.parentElement);else{var c=a.templateUrl||this.templateUrl;c?(this.__deferActivate=!0,BetaJS.Browser.Loader.loadHtml(c,function(b){this.__deferActivate=!1,this._handlerInitializeTemplate(b,a.parentElement),this.__deferedActivate&&this.activate()},this)):this._handlerInitializeTemplate(b,a.parentElement)}},_handlerInitializeTemplate:function(a,b){this.__element?BetaJS.$(this.__element).html(a):b?(BetaJS.$(b).html(a),this.__element=BetaJS.$(b).find(">").get(0)):this.__element=BetaJS.$(a).get(0)},element:function(){return this.__element},activate:function(){return this.__deferActivate?void(this.__deferedActivate=!0):void(this.__rootNode=new BetaJS.Dynamics.Node(this,null,this.__element))}},BetaJS.Class.extend("BetaJS.Dynamics.Handler",[BetaJS.Dynamics.HandlerMixin,{constructor:function(a){this._inherited(BetaJS.Dynamics.Handler,"constructor"),a=a||{},this._properties=a.properties?a.properties:new BetaJS.Properties.Properties,this.functions={},this._handlerInitialize(a)},properties:function(){return this._properties}}],{register:function(a,b){b=b||BetaJS.Dynamics.handlerRegistry,b.register(a,this)}}),BetaJS.Dynamics.handlerRegistry=new BetaJS.Classes.ClassRegistry,BetaJS.Class.extend("BetaJS.Dynamics.HandlerPartial",{constructor:function(a,b,c){this._inherited(BetaJS.Dynamics.HandlerPartial,"constructor"),this._node=a,this._args=b,this._value=c,this._active=!1},change:function(a,b){this._change(a,b),this._apply(a,b)},activate:function(){this._active||(this._active=!0,this._activate(),this._apply(this._value,null))},deactivate:function(){this._active&&(this._active=!1,this._deactivate())},_change:function(){},_activate:function(){},_deactivate:function(){},_apply:function(){},_execute:function(){var a=BetaJS.Dynamics.Parser.parseCode(this._value);this._node.__executeDyn(a)}},{register:function(a,b){b=b||BetaJS.Dynamics.handlerPartialRegistry,b.register(a,this)}}),BetaJS.Dynamics.handlerPartialRegistry=new BetaJS.Classes.ClassRegistry,BetaJS.Class.extend("BetaJS.Dynamics.Node",[BetaJS.Events.EventsMixin,{constructor:function(a,b,c,d){if(this._inherited(BetaJS.Dynamics.Node,"constructor"),this._handler=a,this._parent=b,b&&(b._children[BetaJS.Ids.objectId(this)]=this),this._element=c,this._tag=c.tagName?c.tagName.toLowerCase():"",this._tag.indexOf(":")>=0&&(this._tag=this._tag.substring(this._tag.indexOf(":")+1)),this._dynTag=BetaJS.Dynamics.Parser.parseText(this._tag),this._tagHandler=null,this._$element=BetaJS.$(c),this._template=c.outerHTML,this._innerTemplate=c.innerHTML,this._locals=d||{},this._active=!0,this._dyn=null,this._children={},this._locked=!0,this._attrs={},this._expandChildren=!0,c.attributes)for(var e=0;e<c.attributes.length;++e)this.__initializeAttr(c.attributes[e]);this._locked=!1,this._active&&(this._active=!1,this.activate())},destroy:function(){BetaJS.Objs.iter(this._attrs,function(a){a.partial&&a.partial.destroy(),a.dyn&&this.__dynOff(a.dyn)},this),this._removeChildren(),this._tagHandler&&this._tagHandler.destroy(),this._dyn&&this.properties().off(null,null,this._dyn),this._parent&&delete this._parent._children[BetaJS.Ids.objectId(this)],this._inherited(BetaJS.Dynamics.Node,"destroy")},__propGet:function(a){var b=a.indexOf("."),c=b>=0?a.substring(0,b):a,d=b>=0?a.substring(b+1):null;return d&&c in this._locals&&BetaJS.Properties.Properties.is_instance_of(this._locals[c])?{props:this._locals[c],key:d}:{props:this.properties(),key:a}},__dynOff:function(a){BetaJS.Objs.iter(a.dependencies,function(b){var c=this.__propGet(b);c.props.off("change:"+c.key,null,a)},this)},__dynOn:function(a,b){var c=this;BetaJS.Objs.iter(a.dependencies,function(d){var e=this.__propGet(d);e.props.on("change:"+e.key,function(){b.apply(c)},a)},this)},__initializeAttr:function(a){var b={name:a.name,value:a.value,domAttr:a,dyn:BetaJS.Dynamics.Parser.parseText(a.value)};if(this._attrs[a.name]=b,this.__updateAttr(b),BetaJS.Dynamics.handlerPartialRegistry.get(b.name)&&(b.partial=BetaJS.Dynamics.handlerPartialRegistry.create(b.name,this,b.dyn?b.dyn.args:{},b.value)),b.dyn){this.__dynOn(b.dyn,function(){this.__updateAttr(b)});var c=this;b.dyn.bidirectional&&"value"==b.name&&this._$element.on("change keyup keypress keydown blur focus update",function(){var a=c.__propGet(b.dyn.variable);a.props.set(a.key,c._element.value)})}},__executeDyn:function(a){var b=BetaJS.Objs.map(this._handler.functions,function(a){return BetaJS.Functions.as_method(a,this._handler)},this);return BetaJS.Dynamics.Parser.executeCode(a,[this.properties().data(),this._locals,b])},__updateAttr:function(a){var b=a.dyn?this.__executeDyn(a.dyn):a.value;if(b!=a.value){var c=a.value;a.value=b,a.domAttr.value=b,a.partial&&a.partial.change(b,c),"value"==a.name&&(this._element.value=b),this.trigger("change-attr:"+a.name,b,c)}},__tagValue:function(){return this._dynTag?this.__executeDyn(this._dynTag):this._tag},__unregisterTagHandler:function(){this._tagHandler&&(this.off(null,null,this._tagHandler),this._tagHandler.destroy(),this._tagHandler=null)},__registerTagHandler:function(){this.__unregisterTagHandler();var a=this.__tagValue();if(!BetaJS.Dynamics.handlerRegistry.get(a))return!1;this._tagHandler=BetaJS.Dynamics.handlerRegistry.create(a,{parentElement:this._$element.get(0),parentHandler:this._handler,autobind:!1}),this._$element.append(this._tagHandler.element());for(var b in this._attrs){var c=this._attrs[b];if(!c.partial&&0===b.indexOf("ba-")){var d=b.substring("ba-".length);if(this._tagHandler.properties().set(d,c.value),c.dyn){var e=this;if(this.on("change-attr:"+b,function(a){e._tagHandler.properties().set(d,a)},this._tagHandler),c.dyn.bidirectional){var f=this.__propGet(c.dyn.variable);this._tagHandler.properties().on("change:"+d,function(a){f.props.set(f.key,a)},this)}}}}return this._tagHandler.activate(),!0},activate:function(){if(!this._locked&&!this._active){this._locked=!0,this._active=!0,this._dynTag&&this.__dynOn(this._dynTag,function(){this.__registerTagHandler()});var a=this.__registerTagHandler();if(!a&&this._expandChildren){this._$element.html(this._innerTemplate),this._element.nodeType==this._element.TEXT_NODE&&(this._dyn=BetaJS.Dynamics.Parser.parseText(this._element.textContent),this._dyn&&this.__dynOn(this._dyn,function(){this.__updateDyn()})),this.__updateDyn();for(var b=0;b<this._element.childNodes.length;++b)this._registerChild(this._element.childNodes[b])}this._$element.css("display","");for(var c in this._attrs)this._attrs[c].partial&&this._attrs[c].partial.activate();this._locked=!1}},__updateDyn:function(){if(this._dyn){var a=this.__executeDyn(this._dyn);a!=this._dyn.value&&(this._dyn.value=a,this._element.textContent=a)}},_registerChild:function(a,b){return new BetaJS.Dynamics.Node(this._handler,this,a,BetaJS.Objs.extend(BetaJS.Objs.clone(this._locals,1),b))},_removeChildren:function(){BetaJS.Objs.iter(this._children,function(a){a.destroy()})},deactivate:function(){if(!this._locked&&this._active){this._locked=!0,this._active=!1;for(var a in this._attrs)this._attrs[a].partial&&this._attrs[a].partial.deactivate();this._removeChildren(),this._dynTag&&this.__dynOff(this._dynTag),this.__unregisterTagHandler(),this._dyn&&(this.__dynOff(this._dyn),this._dyn=null),this._$element.html(""),this._locked=!1}},properties:function(){return this._handler.properties()}}]),BetaJS.Dynamics.HandlerPartial.extend("BetaJS.Dynamics.ClassPartial",{_apply:function(a){for(var b in a)a[b]?this._node._$element.addClass(b):this._node._$element.removeClass(b)}}),BetaJS.Dynamics.ClassPartial.register("ba-class"),BetaJS.Dynamics.HandlerPartial.extend("BetaJS.Dynamics.ClickPartial",{constructor:function(a,b,c){this._inherited(BetaJS.Dynamics.ClickPartial,"constructor",a,b,c);var d=this;this._node._$element.on("click",function(){d._execute()})}}),BetaJS.Dynamics.ClickPartial.register("ba-click"),BetaJS.Dynamics.HandlerPartial.extend("BetaJS.Dynamics.IfPartial",{_apply:function(a){a?this._node.activate():this._node.deactivate()}}),BetaJS.Dynamics.IfPartial.register("ba-if"),BetaJS.Dynamics.HandlerPartial.extend("BetaJS.Dynamics.RepeatPartial",{constructor:function(a,b,c){this._inherited(BetaJS.Dynamics.RepeatPartial,"constructor",a,b,c),a._expandChildren=!1,a._$element.html("")},_activate:function(){this.__register(this._value)},_deactivate:function(){this.__unregister()},_change:function(a){this.__register(a)},__register:function(a){this.__unregister(),BetaJS.Collections.Collection.is_instance_of(a)?(this.__collection=a,this.__collection_map={},this.__collection.iterate(function(a){this.__collection_map[a.cid()]=this.__appendItem(a)},this),this.__collection.on("add",function(a){this.__collection_map[a.cid()]=this.__appendItem(a)},this)):BetaJS.Objs.iter(a,this.__appendItem,this)},__unregister:function(){var a=this._node._$element;this._node._removeChildren(),a.html(""),this.__collection&&(this.__collection.off(null,null,this),this.__collection=null,this.__collection_map=null)},__appendItem:function(a){this._node._$element.append(this._node._innerTemplate);var b=this._node._$element.find(">:last").get(0),c={};return this._args&&(c[this._args]=a),this._node._registerChild(b,c),b}}),BetaJS.Dynamics.RepeatPartial.register("ba-repeat"),BetaJS.Dynamics.HandlerPartial.extend("BetaJS.Dynamics.ReturnPartial",{constructor:function(a,b,c){this._inherited(BetaJS.Dynamics.ReturnPartial,"constructor",a,b,c);var d=this;this._node._$element.on("keypress",function(a){13===a.which&&d._execute()})}}),BetaJS.Dynamics.ReturnPartial.register("ba-return"),BetaJS.Dynamics.HandlerPartial.extend("BetaJS.Dynamics.ShowPartial",{_apply:function(a){a?this._node._$element.show():this._node._$element.hide()}}),BetaJS.Dynamics.ShowPartial.register("ba-show"),BetaJS.Scopes.Scope.extend("BetaJS.Dynamics.Dynamic",[BetaJS.Dynamics.HandlerMixin,{constructor:function(a){if(a=BetaJS.Objs.extend(this.initial,a),!a.parent&&a.parentHandler)for(var b=a.parentHandler;b&&!a.parent;)a.parent=b.instance_of(BetaJS.Dynamics.Dynamic)?b:null,b=b._parentHandler;this._inherited(BetaJS.Dynamics.Dynamic,"constructor",a),this.functions=this.__functions,this._handlerInitialize(a),a.create&&a.create.apply(this)}}],{register:function(a,b){b=b||BetaJS.Dynamics.handlerRegistry,b.register(a,this)},activate:function(a){var b=new this(a);return b.activate(),b}});